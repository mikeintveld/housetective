<!-- Supabase client (browser) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ==== BOOTSTRAP AUTH (shared) ==== -->
<script>
  window.htAuth = (function () {
    const supabaseUrl = "https://housetective-4tej.supabase.co";   // your Supabase URL
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppdHhxcHRrYW5ja3VkbW5nZWNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNTMwMjQsImV4cCI6MjA3MDgyOTAyNH0.dIO7P3yL5xezQfD-JcuA4ZWohr3SKfuVPX_JdGPrRdQ";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey, {
      auth: { persistSession: true, detectSessionInUrl: true }
    });

    async function getUser() {
      // Prefer getUser (fresh server check). Fallback to session user.
      const { data: u1 } = await supabase.auth.getUser();
      if (u1?.user) return u1.user;
      const { data: s } = await supabase.auth.getSession();
      return s?.session?.user ?? null;
    }

    async function authHeader() {
      const { data } = await supabase.auth.getSession();
      const token = data?.session?.access_token;
      return token ? { Authorization: `Bearer ${token}` } : {};
    }

    async function ensureSessionOrRedirect() {
      const user = await getUser();
      if (user) return user;
      const returnTo = encodeURIComponent(location.pathname + location.search);
      location.href = `https://www.housetective.com/log-in?return=${returnTo}`;
      return null;
    }

    async function signOut() { await supabase.auth.signOut(); }

    // Broadcast auth state so other scripts can update UI reactively
    supabase.auth.onAuthStateChange(() => {
      window.dispatchEvent(new CustomEvent("ht-auth-changed"));
    });

    return { supabase, getUser, authHeader, ensureSessionOrRedirect, signOut };
  })();
</script>

<!-- ==== PAGE STYLES (layout + components) ==== -->
<style>
  :root{
    --brand:#2563eb; --brand-600:#1d4ed8;
    --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
    --card:#fff; --bg:#f3f5fb; --shadow:0 12px 28px rgba(16,24,40,.06);
    --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626;
    --sidebar:240px; --radius:14px; --space:18px;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}

  .wrap{display:grid;grid-template-columns:var(--sidebar) 1fr;min-height:100vh}
  .aside{background:#fff;border-right:1px solid var(--border);padding:18px 14px;position:sticky;top:0;height:100vh;z-index:2}
  .main{padding:22px 18px;max-width:1100px;width:100%;margin:0 auto}

  .brand{display:flex;align-items:center;gap:10px;padding:6px 8px;margin-bottom:14px;font-weight:800;font-size:18px}
  .badge{width:32px;height:32px;border-radius:10px;display:grid;place-items:center;background:linear-gradient(135deg,#5aa2ff,#7b5cff);color:#fff;font-weight:800}
  .nav{margin-top:10px;display:grid;gap:6px}
  .nav a{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;color:#334155;text-decoration:none;border:1px solid transparent;font-weight:500}
  .nav a:hover{background:#f5f7ff}
  .nav a.active{background:#eaf1ff;border-color:#cfe0ff;color:#0f172a}

  /* Floating Log In / Account button (always clickable) */
  .login-fixed{
    position:fixed;left:18px;bottom:18px;width:calc(var(--sidebar) - 36px);
    background:var(--brand);color:#fff;border-radius:10px;padding:10px 12px;text-align:center;
    text-decoration:none;font-weight:700;box-shadow:0 6px 18px rgba(37,99,235,.18);
    z-index:10000; pointer-events:auto; cursor:pointer; border:0;
  }
  .login-fixed:hover{background:var(--brand-600)}
  .login-fixed.ring{ box-shadow:0 0 0 4px rgba(37,99,235,.25)!important; }

  /* Optional: if overlays exist in your theme */
  *[data-overlay], .page-overlay { pointer-events:none; }

  h1{font-size:28px;font-weight:800;margin:0 0 6px}
  .sub{color:var(--muted);margin:0 0 18px;font-size:15px}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:var(--space)}
</style>

<div class="wrap">
  <!-- Sidebar -->
  <aside class="aside">
    <div class="brand"><span class="badge">HT</span>Housetective</div>
    <nav class="nav">
      <a href="/ai-checker-dashboard-students-free">Dashboard</a>
      <a class="active" href="/ai-ad-checker-students-copy">Scam Checker</a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <h1>Scam Checker</h1>
    <p class="sub">Upload rental listings to detect potential scams</p>

    <!-- ===== Checker UI ===== -->
    <div class="ht-wrap">
      <!-- LEFT -->
      <section class="ht-card ht-left">
        <h2 class="ht-h">Upload screenshots</h2>
        <p class="ht-sub">PNG/JPG ‚Ä¢ up to 8 MB each ‚Ä¢ max 8 images</p>

        <!-- Dropzone -->
        <div id="ht-drop" class="ht-drop">
          <div class="ht-drop-inner">
            <div class="ht-cam" aria-hidden="true">üì∑</div>
            <div class="ht-strong">Drag &amp; drop images</div>
            <div class="ht-muted">or</div>
            <button id="ht-pick" class="ht-btn ghost small" type="button">Choose files</button>
            <input id="ht-file" type="file" accept="image/png,image/jpeg" multiple hidden>
          </div>
        </div>

        <!-- Thumbs -->
        <div id="ht-thumbs" class="ht-thumbs" hidden></div>

        <!-- Notes -->
        <label for="ht-notes" class="ht-label">Optional message</label>
        <textarea id="ht-notes" class="ht-textarea" rows="4" placeholder="Anything else we should know?"></textarea>

        <!-- Actions -->
        <div class="ht-actions">
          <button id="ht-clear" class="ht-btn ghost" type="button">Clear</button>
          <button id="ht-check" class="ht-btn primary" type="button">
            <span>Check screenshots</span><span class="ht-spin"></span>
          </button>
        </div>

        <p class="ht-foot">We only use your images to assess risk. Nothing is stored.</p>
      </section>

      <!-- RIGHT -->
      <aside id="ht-panel" class="ht-card ht-right">
        <div class="ht-skeleton">
          <div class="ht-skel-ring"></div>
          <div class="ht-skel-heading"></div>
          <div class="ht-skel-line"></div>
          <div class="ht-skel-line"></div>
          <div class="ht-skel-line"></div>
        </div>
      </aside>
    </div>

    <!-- ==== Checker Styles (component) ==== -->
    <style>
      :root{
        --brand:#2563eb; --brand-600:#1d4ed8;
        --text:#0f172a; --muted:#64748b; --border:#e5e7eb;
        --card:#f8fafc; --white:#fff; --shadow:0 14px 40px rgba(2,6,23,.08);
        --ok:#16a34a; --warn:#f59e0b; --bad:#dc2626; --r:16px;
      }
      .ht-wrap{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:22px}
      @media (max-width:900px){.ht-wrap{grid-template-columns:1fr}}
      .ht-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r);box-shadow:var(--shadow);padding:18px}
      .ht-left{background:var(--card)}
      .ht-h{margin:0 0 4px;font-size:1.25rem;font-weight:800}
      .ht-sub{margin:0 0 12px;color:var(--muted)}

      .ht-drop{border:1.5px dashed var(--border);border-radius:14px;background:#fff;transition:.15s}
      .ht-drop.drag{border-color:var(--brand);background:#f1f5ff}
      .ht-drop-inner{padding:28px;text-align:center}
      .ht-cam{font-size:32px;margin-bottom:8px}
      .ht-strong{font-weight:800}
      .ht-muted{color:var(--muted);margin:4px 0}

      .ht-btn{border:1px solid transparent;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;transition:.15s;line-height:1}
      .ht-btn.primary{background:var(--brand);color:#fff}
      .ht-btn.primary:hover{background:var(--brand-600)}
      .ht-btn.ghost{background:#fff;border-color:var(--border);color:#000}
      .ht-btn.ghost:hover{border-color:var(--brand);color:var(--brand)}
      .ht-btn.small{padding:10px 12px;border-radius:10px;font-size:14px}
      .ht-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
      .ht-actions .ht-btn{box-shadow:0 1px 0 rgba(0,0,0,.03)}

      .ht-thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-top:12px}
      .ht-thumb{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
      .ht-thumb img{width:100%;height:110px;object-fit:cover}
      .ht-remove{position:absolute;top:6px;right:6px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;cursor:pointer}

      .ht-label{font-weight:700;margin-top:10px;display:block}
      .ht-textarea{width:100%;border:1px solid var(--border);border-radius:12px;padding:12px 14px;background:#fff;outline:none}
      .ht-textarea:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(37,99,235,.08)}
      .ht-foot{color:var(--muted);font-size:.9rem;text-align:center;margin:6px 0 0}

      .ht-spin{display:none;width:16px;height:16px;margin-left:8px;border-radius:50%;
        border:2px solid rgba(255,255,255,.6);border-top-color:#fff;animation:spin .7s linear infinite}
      .ht-btn.loading .ht-spin{display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}

      .ht-ring{width:96px;height:96px;border-radius:50%;background:conic-gradient(#fecaca 0 var(--pct),#ffe4e6 var(--pct) 100%);display:grid;place-items:center;margin:0 auto 10px;position:relative}
      .ht-ring::after{content:'';position:absolute;inset:8px;background:#fff;border-radius:50%}
      .ht-ring b{position:relative;font-size:20px;font-weight:800}
      .ht-center{text-align:center}
      .ht-head{margin:8px 0 2px;font-weight:800;font-size:1.05rem}
      .ht-subtle{color:#64748b;margin:0 0 10px}

      .ht-list{display:grid;gap:8px}
      .ht-item{display:flex;align-items:center;gap:10px;border:1px solid #fee2e2;background:#fff7f7;border-radius:12px;padding:10px 12px}
      .ht-ok{display:flex;align-items:center;gap:10px;border:1px solid #dcfce7;background:#f0fdf4;border-radius:12px;padding:10px 12px}
      .ht-icon{color:#dc2626}
      .ht-badge{margin-left:auto;font-size:12px;border-radius:999px;padding:4px 8px;border:1px solid #fecaca;background:#fff;min-width:70px;text-align:center}
      .sev-critical{border-color:#fecaca;background:#fee2e2;color:#991b1b}
      .sev-high{border-color:#fecaca;color:#b91c1c}
      .sev-medium{border-color:#fde68a;color:#92400e}
      .ht-section{margin-top:14px}
      .ht-section h4{margin:0 0 6px}
      .ht-ul{margin:0;padding-left:18px}
      .ht-reco{display:flex;gap:10px;border:1px solid #fde68a;background:#fffbeb;border-radius:12px;padding:12px 14px}
      .ht-right{position:sticky;top:10px}
      .ht-skeleton{display:grid;gap:12px}
      .ht-skel-ring{width:96px;height:96px;border-radius:50%;background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;animation:sk 1.2s infinite;margin:0 auto}
      .ht-skel-heading,.ht-skel-line{height:14px;border-radius:8px;background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;animation:sk 1.2s infinite}
      .ht-skel-heading{width:70%;height:18px;margin:0 auto}
      .ht-skel-line{width:100%}
      @keyframes sk{to{background-position:200% 0}}
    </style>

    <!-- ==== Checker Logic (auth-aware) ==== -->
    <script>
    (function(){
      const BASE = "https://housetective-4tej.vercel.app";
      const API  = `${BASE}/api/verify`;
      const SAVE = `${BASE}/api/checks/new`;
      const MAX_FILES = 8, PER_FILE_LIMIT = 8*1024*1024;
      const MAX_TOTAL_BYTES = 3.5*1024*1024;
      const LONG_SIDE = 1600, QUALITY = 0.8;

      const $ = s=>document.querySelector(s);
      const drop=$("#ht-drop"), pick=$("#ht-pick"), file=$("#ht-file"), thumbs=$("#ht-thumbs");
      const notes=$("#ht-notes"), checkBtn=$("#ht-check"), panel=$("#ht-panel");

      let images=[];

      const dataUrlBytes = d=>Math.ceil(((d.split(",")[1]||"").length*3)/4);
      function fit(w,h,max){ if(w<=max&&h<=max)return {w,h}; return w>=h?{w:max,h:Math.round(h*(max/w))}:{w:Math.round(w*(max/h)),h:max}; }
      function fileToImage(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=r.result};r.onerror=rej;r.readAsDataURL(file);});}
      async function compress(file){ const img=await fileToImage(file); const {w,h}=fit(img.naturalWidth,img.naturalHeight,LONG_SIDE); const c=document.createElement("canvas"); c.width=w;c.height=h; c.getContext("2d").drawImage(img,0,0,w,h); return c.toDataURL("image/jpeg",QUALITY); }

      const sevClass = s => { s=String(s||"").toLowerCase(); if(s.includes("critical"))return"sev-critical"; if(s.includes("high"))return"sev-high"; return"sev-medium"; };
      const sevText  = s => { s=String(s||"").toUpperCase(); return /CRITICAL|HIGH|MEDIUM/.test(s)?s:"MEDIUM"; };

      function fallbackScore(redFlags){
        if(!Array.isArray(redFlags) || !redFlags.length) return 10;
        let s = 0;
        redFlags.forEach(r=>{
          const sev = String(r.severity||"").toLowerCase();
          if(sev.includes("critical")) s += 35;
          else if(sev.includes("high")) s += 22;
          else s += 12;
        });
        return Math.max(0, Math.min(100, s));
      }
      function verdictFromScore(score){
        if(score>=60) return {title:"High Scam Risk Detected", color:"#dc2626"};
        if(score>=40) return {title:"Likely-scam",              color:"#f59e0b"};
        return {title:"Low Scam Risk",                           color:"#16a34a"};
      }

      function renderThumbs(){
        thumbs.innerHTML=""; if(!images.length){thumbs.hidden=true;return;} thumbs.hidden=false;
        images.forEach(img=>{
          const d=document.createElement("div"); d.className="ht-thumb";
          d.innerHTML=`<img src="${img.dataUrl}" alt="${img.name}"><button class="ht-remove" type="button" data-id="${img.id}">√ó</button>`;
          thumbs.appendChild(d);
        });
        thumbs.querySelectorAll(".ht-remove").forEach(b=>b.onclick=()=>{images=images.filter(i=>i.id!==b.dataset.id);renderThumbs();});
      }

      async function addFiles(list){
        const arr=Array.from(list||[]);
        if(images.length+arr.length>MAX_FILES){alert(`Max ${MAX_FILES} images.`);return;}
        for(const f of arr){
          if(!/^image\/(png|jpe?g)$/i.test(f.type)){alert("Only PNG/JPG allowed.");continue;}
          if(f.size>PER_FILE_LIMIT){alert(`${f.name} is too large (max 8 MB).`);continue;}
          const dataUrl=await compress(f); const bytes=dataUrlBytes(dataUrl);
          const total=images.reduce((s,i)=>s+i.bytes,0)+bytes;
          if(total>MAX_TOTAL_BYTES){alert(`Total size too large. Try fewer/smaller screenshots.`);break;}
          images.push({id:crypto.randomUUID(),name:f.name,dataUrl,bytes});
        }
        renderThumbs();
      }

      ["dragenter","dragover"].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.add("drag");}));
      ["dragleave","drop"].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.remove("drag");}));
      drop.addEventListener("drop",e=>addFiles(e.dataTransfer.files));
      pick.onclick=()=>file.click(); file.onchange=()=>addFiles(file.files);

      function loading(on){ if(on){checkBtn.disabled=true;checkBtn.classList.add("loading");} else{checkBtn.disabled=false;checkBtn.classList.remove("loading");} }

      function renderSkeleton(){
        panel.innerHTML = `<div class="ht-skeleton">
          <div class="ht-skel-ring"></div><div class="ht-skel-heading"></div>
          <div class="ht-skel-line"></div><div class="ht-skel-line"></div><div class="ht-skel-line"></div>
        </div>`;
      }

      function renderResult(data){
        if(!data){ renderSkeleton(); return; }
        const redFlags  = Array.isArray(data.red_flags)   ? data.red_flags   : [];
        const signals   = Array.isArray(data.top_signals) ? data.top_signals : [];
        const advice    = Array.isArray(data.advice)      ? data.advice      : [];
        const recText   = data.recommendation || (redFlags.length
                        ? "Do not proceed with this rental. The ad shows clear signs of a scam. Consider verified alternatives."
                        : "Looks OK, but still verify identities and avoid paying before viewing.");

        const score = Number.isFinite(Number(data.score)) ? Number(data.score) : fallbackScore(redFlags);
        const v = verdictFromScore(score);
        const pct = Math.max(0, Math.min(100, score)) + "%";
        const subtitle = redFlags.length ? "This listing contains multiple red flags" : "No obvious red flags detected from screenshots";

        panel.innerHTML = `
          <div class="ht-center">
            <div class="ht-ring" style="--pct:${pct}"><b style="color:${v.color}">${score}</b></div>
            <div class="ht-head" style="color:${v.color}">${v.title}</div>
            <p class="ht-subtle">${subtitle}</p>
          </div>
          <div class="ht-section">
            <h4>Red Flags Detected:</h4>
            <div class="ht-list">
              ${
                redFlags.length
                  ? redFlags.map(r => `
                      <div class="ht-item">
                        <span class="ht-icon">‚ö†Ô∏è</span>
                        <div>${r.text || ""}</div>
                        <span class="ht-badge ${sevClass(r.severity)}">${sevText(r.severity)}</span>
                      </div>`).join("")
                  : `<div class="ht-ok"><span aria-hidden="true">‚úÖ</span><div>No obvious red flags detected.</div></div>`
              }
            </div>
          </div>
          <div class="ht-section">
            <h4>Top signals</h4>
            ${ signals.length ? `<ul class="ht-ul">${signals.map(s=>`<li>${s}</li>`).join("")}</ul>`
                              : `<div class="ht-subtle">No specific positive signals extracted.</div>` }
          </div>
          <div class="ht-section">
            <h4>Advice</h4>
            ${ advice.length ? `<ul class="ht-ul">${advice.map(a=>`<li>${a}</li>`).join("")}</ul>`
                             : `<div class="ht-subtle">No tailored advice available.</div>` }
          </div>
          <div class="ht-reco">
            <span aria-hidden="true">‚ö†Ô∏è</span>
            <div><strong>Recommendation:</strong> ${recText}</div>
          </div>`;
      }

      async function callAPI(payload){
        const once = async ()=>{
          const res = await fetch(API, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
          if(!res.ok){ let b={}; try{b=await res.json();}catch{} const e=new Error(b.error||`Server error ${res.status}`); e.status=res.status; throw e; }
          return res.json();
        };
        try { return await once(); }
        catch(e){ if(e.status===429){ await new Promise(r=>setTimeout(r,1500)); return once(); } throw e; }
      }

      function drawAttentionToLogin(){
        const b = document.getElementById('ht-login');
        if (b) { b.focus(); b.classList.add('ring'); setTimeout(()=>b.classList.remove('ring'), 900); }
      }

      $("#ht-clear").onclick = ()=>{ images=[]; renderThumbs(); renderResult(null); notes.value=""; };

      $("#ht-check").onclick = async ()=>{
        // 1) Ensure logged in, otherwise redirect to https://www.housetective.com/log-in
        const user = await htAuth.ensureSessionOrRedirect();
        if (!user) return;

        if(!images.length){ panel.innerHTML = `<div class="ht-ok"><span>‚ÑπÔ∏è</span><div>Please upload at least one screenshot.</div></div>`; return; }
        const total = images.reduce((s,i)=>s+i.bytes,0);
        if(total>MAX_TOTAL_BYTES){ panel.innerHTML = `<div class="ht-item"><span class="ht-icon">‚ö†Ô∏è</span><div>Total upload too large. Remove a few images.</div></div>`; return; }

        try{
          loading(true); renderResult(null);

          // 2) Risk analysis (no auth required)
          const payload = {
            imageDataUrls: images.map(i=>i.dataUrl),
            imageDataUrl: images[0].dataUrl,
            meta: { notes: (notes.value||"").trim() }
          };
          const data = await callAPI(payload);
          renderResult(data);

          // 3) Save to Supabase via Vercel with Authorization header
          try {
            const numericScore = Number(data?.score);
            const score = Number.isFinite(numericScore) ? numericScore : fallbackScore(data?.red_flags || []);
            const payloadForDb = {
              score,
              red_flags: Array.isArray(data?.red_flags) ? data.red_flags : [],
              top_signals: Array.isArray(data?.top_signals) ? data.top_signals : [],
              advice: Array.isArray(data?.advice) ? data.advice : [],
              recommendation: data?.recommendation || '',
              notes: (notes?.value || '').trim()
            };
            const resp = await fetch(SAVE, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', ...(await htAuth.authHeader()) },
              body: JSON.stringify(payloadForDb)
            });
            const json = await resp.json().catch(()=> ({}));
            console.log('[save] response', resp.status, json);

            if (resp.status === 401) {
              alert('Your session expired. Please log in again.');
              const returnTo = encodeURIComponent(location.pathname + location.search);
              location.href = `https://www.housetective.com/log-in?return=${returnTo}`;
              return;
            }
            if (!resp.ok) throw new Error(json?.error || `Save failed ${resp.status}`);
          } catch (err) {
            console.error('[save] error', err);
          }
        } catch(e){
          const msg = e.message && e.message.includes("Failed to fetch")
            ? "Network/CORS error: the browser could not reach the API."
            : e.message || "Something went wrong.";
          panel.innerHTML = `<div class="ht-item"><span class="ht-icon">‚ö†Ô∏è</span><div>${msg}</div></div>`;
          console.error(e);
        } finally { loading(false); }
      };

      // Init UI
      renderThumbs(); renderResult(null);

      // Keep the floating button in sync with auth
      async function syncLoginCta(){
        const btn = document.getElementById('ht-login');
        if (!btn) return;
        const user = await htAuth.getUser();
        if (user) {
          btn.textContent = 'Account';
          btn.href = '/ai-checker-dashboard-students-free';
          btn.title = user.email || '';
        } else {
          btn.textContent = 'Log In';
          btn.href = 'https://www.housetective.com/log-in';
          btn.removeAttribute('title');
        }
      }
      syncLoginCta();
      window.addEventListener("ht-auth-changed", syncLoginCta);
    })();
    </script>
  </main>
</div>

<!-- Floating Log In / Account -->
<a id="ht-login" class="login-fixed" href="https://www.housetective.com/log-in">Log In</a>
